# TDD 三阶段规则

## 核心原理

TDD (Test-Driven Development) 遵循严格的三阶段循环：

```
RED → GREEN → REFACTOR → RED → ...
```

每个阶段都有明确的职责和限制，确保代码质量和设计的渐进式改善。

## 阶段详解

### 🔴 RED 阶段
**目标**: 编写一个失败的测试

**允许操作**:
- ✅ 编写新的测试用例
- ✅ 修改现有测试用例
- ✅ 编写测试辅助代码

**禁止操作**:
- ❌ 修改生产代码
- ❌ 修改配置文件
- ❌ 重构现有代码

**成功标准**:
- 新测试必须失败
- 失败原因必须明确
- 测试代码质量良好
- 测试表达了明确的需求

**退出条件**: 有一个测试因为预期的原因失败

### 🟢 GREEN 阶段
**目标**: 用最简单的方式让测试通过

**允许操作**:
- ✅ 编写生产代码
- ✅ 创建必要的类和方法
- ✅ 实现最简单的解决方案

**禁止操作**:
- ❌ 修改测试逻辑
- ❌ 重构现有代码
- ❌ 过度工程化

**成功标准**:
- 所有测试都通过
- 实现是最简解决方案
- 不引入额外复杂性

**退出条件**: 所有测试都通过

### 🔧 REFACTOR 阶段
**目标**: 在保持测试绿色的前提下改善代码质量

**允许操作**:
- ✅ 重构生产代码
- ✅ 提取方法和类
- ✅ 优化算法和性能
- ✅ 改善代码可读性
- ✅ 更新文档和注释

**禁止操作**:
- ❌ 修改测试行为
- ❌ 添加新功能
- ❌ 破坏现有测试

**成功标准**:
- 所有测试保持绿色
- 代码质量得到改善
- 设计更加清晰

**退出条件**: 代码质量满意，准备下一个RED循环

## 阶段转换规则

### RED → GREEN
- 必须有失败的测试
- 测试失败原因符合预期
- 准备开始实现

### GREEN → REFACTOR  
- 所有测试通过
- 有代码质量改善的空间
- 实现功能完整

### REFACTOR → RED
- 代码质量满意
- 所有测试保持绿色
- 准备添加新功能

### 任意阶段 → READY
- 完成当前功能开发
- 所有测试通过
- 代码已提交

## 质量门控

### 自动检查
- **文件编辑权限**: 根据当前阶段限制可编辑文件类型
- **测试状态监控**: 实时跟踪测试通过状态
- **提交验证**: 确保提交符合当前阶段要求

### 人工检查点
- **RED阶段检查**: 测试是否正确表达需求
- **GREEN阶段检查**: 实现是否足够简单
- **REFACTOR阶段检查**: 重构是否改善了设计

## 最佳实践

### 测试编写
- 测试名称应清晰表达意图
- 使用Given-When-Then结构
- 一个测试只验证一个行为
- 测试应该快速且独立

### 实现策略
- 选择最简单可行的解决方案
- 避免预测性设计
- 专注于让测试通过
- 推迟优化到REFACTOR阶段

### 重构原则
- 小步重构，频繁验证
- 保持测试绿色
- 改善设计而不是添加功能
- 提高代码可读性和维护性

## 常见陷阱

### RED阶段
- ❌ 测试写得太复杂
- ❌ 同时测试多个行为
- ❌ 测试依赖外部状态

### GREEN阶段
- ❌ 过度设计解决方案
- ❌ 修改测试以适应实现
- ❌ 引入不必要的抽象

### REFACTOR阶段
- ❌ 破坏现有测试
- ❌ 添加新功能
- ❌ 大幅度重构导致不稳定